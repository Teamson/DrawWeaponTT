{
  "code": "import Utility from \"../Mod/Utility\";\r\nimport GameLogic from \"../Crl/GameLogic\";\r\nimport PlayerDataMgr from \"../Libs/PlayerDataMgr\";\r\nimport WxApi from \"../Libs/WxApi\";\r\nimport GameTopNode from \"./GameTopNode\";\r\nimport PrefabManager, { PrefabItem } from \"../Libs/PrefabManager\";\r\nimport FixPlayerHpBar from \"../Crl/FixPlayerHpBar\";\r\nimport FixAiTips from \"../Crl/FixAiTips\";\r\nimport SoundMgr from \"../Mod/SoundMgr\";\r\nimport JJMgr, { SceneDir } from \"../JJExport/Common/JJMgr\";\r\nimport AdMgr from \"../Mod/AdMgr\";\r\nexport default class GameUI extends Laya.Scene {\r\n    constructor() {\r\n        super();\r\n        this.touchPanel = this['touchPanel'];\r\n        this.touchNode = this['touchNode'];\r\n        this.drawSp = this['drawSp'];\r\n        this.btnNode = this['btnNode'];\r\n        this.noPowerNode = this['noPowerNode'];\r\n        this.upgradeNode = this['upgradeNode'];\r\n        this.closeUpgradePlane = this['closeUpgradePlane'];\r\n        this.moveNode = this['moveNode'];\r\n        this.item1 = this['item1'];\r\n        this.item2 = this['item2'];\r\n        this.item3 = this['item3'];\r\n        this.getPowerBtn = this['getPowerBtn'];\r\n        this.upgradeBtn = this['upgradeBtn'];\r\n        this.skinBtn = this['skinBtn'];\r\n        this.reviveBtn = this['reviveBtn'];\r\n        this.startBtn = this['startBtn'];\r\n        this.overNode = this['overNode'];\r\n        this.bottomNode = this['bottomNode'];\r\n        this.gameOverNode = this['gameOverNode'];\r\n        this.helpBtn = this['helpBtn'];\r\n        this.giveUpBtn = this['giveUpBtn'];\r\n        this.gameOverBtnNode = this['gameOverBtnNode'];\r\n        this.playerHp = this['playerHp'];\r\n        this.aiHp = this['aiHp'];\r\n        this.moreGameBtn = this['moreGameBtn'];\r\n        this.drawGameBtn = this['drawGameBtn'];\r\n        this.touchStarted = false;\r\n        this.startPos = null;\r\n        this.lineArr = [];\r\n        this.lineArrVec2 = [];\r\n    }\r\n    onOpened(param) {\r\n        GameUI.Share = this;\r\n        this.initData();\r\n        param && param();\r\n        Laya.timer.frameLoop(1, this, this.checkIsNoPower);\r\n        if (!WxApi.launchGameUI) {\r\n            WxApi.GetLaunchParam((param) => {\r\n                let et = PlayerDataMgr.getPlayerData().exitTime;\r\n                if (et > 0) {\r\n                    let curT = new Date().getTime();\r\n                    let diffT = Math.floor((curT - et) / 1000 / 60);\r\n                    if (diffT >= 1) {\r\n                        Laya.Scene.open('MyScenes/OfflineUI.scene', false, diffT);\r\n                    }\r\n                }\r\n            });\r\n            WxApi.launchGameUI = true;\r\n            GameLogic.Share.checkCanUpgrade();\r\n        }\r\n        this['drawTips'].visible = PlayerDataMgr.getPlayerData().grade <= 2;\r\n        this['drawTips'].skin = PlayerDataMgr.getPlayerData().grade == 1 ? 'mainUI/sy_ck2.png' : 'mainUI/sy_ck1.png';\r\n        if (!localStorage.getItem('guide') && PlayerDataMgr.getPlayerData().grade == 1) {\r\n            this['fingerAni'].visible = true;\r\n        }\r\n        else {\r\n            this['fingerAni'].visible = false;\r\n        }\r\n        SoundMgr.instance.playMusic('bgm.mp3');\r\n    }\r\n    onClosed() {\r\n        Laya.timer.clearAll(this);\r\n    }\r\n    initData() {\r\n        this.touchPanel.y = Utility.fixPosY(this.touchPanel.y);\r\n        this.bottomNode.y = Utility.fixPosY(this.bottomNode.y);\r\n        this.gameOverBtnNode.y = Utility.fixPosY(this.gameOverBtnNode.y);\r\n        this.touchNode.on(Laya.Event.MOUSE_DOWN, this, this.touchStart);\r\n        this.touchNode.on(Laya.Event.MOUSE_MOVE, this, this.touchMove);\r\n        this.touchNode.on(Laya.Event.MOUSE_UP, this, this.touchEnd);\r\n        this.touchNode.on(Laya.Event.MOUSE_OUT, this, this.touchOut);\r\n        this.upgradeBtn.on(Laya.Event.CLICK, this, this.upgradeBtnCB);\r\n        this.skinBtn.on(Laya.Event.CLICK, this, this.skinBtnCB);\r\n        this.item1.on(Laya.Event.CLICK, this, this.upgradePlayerCountCB);\r\n        this.item2.on(Laya.Event.CLICK, this, this.upgradePlayerAtkCB);\r\n        this.item3.on(Laya.Event.CLICK, this, this.upgradeOfflineCB);\r\n        this.reviveBtn.on(Laya.Event.CLICK, this, this.reviveBtnCB);\r\n        this.startBtn.on(Laya.Event.CLICK, this, this.startCB);\r\n        this.helpBtn.on(Laya.Event.CLICK, this, this.helpBtnCB);\r\n        this.giveUpBtn.on(Laya.Event.CLICK, this, this.giveUpBtnCB);\r\n        this.getPowerBtn.on(Laya.Event.CLICK, this, this.getPowerBtnCB);\r\n        this.moreGameBtn.on(Laya.Event.CLICK, this, this.moreGameBtnCB);\r\n        this.drawGameBtn.on(Laya.Event.CLICK, this, this.drawGameBtnCB);\r\n        Utility.rotateLoop(this.drawGameBtn.getChildAt(0), 20, 200);\r\n        Utility.scaleLoop(this.moreGameBtn.getChildAt(0), 1.2, 500);\r\n        this.updatePlayerItem();\r\n        Laya.timer.loop(1000, this, this.updatePlayerItem);\r\n        GameLogic.Share.canTouch = true;\r\n    }\r\n    updatePlayerItem() {\r\n        let item = null;\r\n        let showTips = false;\r\n        for (let i = 1; i <= 3; i++) {\r\n            item = this['item' + i];\r\n            let lvNum = item.getChildByName('lvNum');\r\n            let cost = item.getChildByName('cost');\r\n            let panel = item.getChildByName('panel');\r\n            switch (i) {\r\n                case 1:\r\n                    lvNum.text = '等级：' + PlayerDataMgr.getPlayerCountLv().toString();\r\n                    cost.text = PlayerDataMgr.getUpgradePlayerCountLvCost().toString();\r\n                    panel.visible = PlayerDataMgr.getUpgradePlayerCountLvCost() > PlayerDataMgr.getPlayerData().coin || PlayerDataMgr.getCountLvMax();\r\n                    break;\r\n                case 2:\r\n                    lvNum.text = '等级：' + PlayerDataMgr.getPlayerPowerLv().toString();\r\n                    cost.text = PlayerDataMgr.getUpgradePlayerPowerLvCost().toString();\r\n                    panel.visible = PlayerDataMgr.getUpgradePlayerPowerLvCost() > PlayerDataMgr.getPlayerData().coin || PlayerDataMgr.getPowerLvMax();\r\n                    break;\r\n                case 3:\r\n                    lvNum.text = '等级：' + PlayerDataMgr.getPlayerOfflineLv().toString();\r\n                    cost.text = PlayerDataMgr.getUpgradeOfflineLvCost().toString();\r\n                    panel.visible = PlayerDataMgr.getUpgradeOfflineLvCost() > PlayerDataMgr.getPlayerData().coin || PlayerDataMgr.getOfflineLvMax();\r\n                    break;\r\n            }\r\n            if (!panel.visible) {\r\n                showTips = true;\r\n            }\r\n        }\r\n        let tips = this.upgradeBtn.getChildAt(0);\r\n        tips.visible = showTips;\r\n    }\r\n    touchStart(event) {\r\n        if (!this.safeArea(new Laya.Vector2(event.stageX, event.stageY)) || !GameLogic.Share.canTouch) {\r\n            return;\r\n        }\r\n        this['fingerAni'].visible = false;\r\n        if (!localStorage.getItem('guide')) {\r\n            localStorage.setItem('guide', '1');\r\n        }\r\n        if (PlayerDataMgr.getPlayerData().gradeIndex == 0 && !GameLogic.Share.gameStarted) {\r\n            PlayerDataMgr.getPlayerData().power--;\r\n            PlayerDataMgr.setPlayerData();\r\n            GameLogic.Share.gameStarted = true;\r\n        }\r\n        this.touchStarted = true;\r\n        this.startPos = new Laya.Vector2(event.stageX, event.stageY);\r\n        this.lineArr = [];\r\n        this.lineArr.push(this.startPos.x);\r\n        this.lineArr.push(this.startPos.y);\r\n        this.lineArrVec2 = [];\r\n        this.lineArrVec2.push(this.startPos);\r\n    }\r\n    touchMove(event) {\r\n        if (!this.safeArea(new Laya.Vector2(event.stageX, event.stageY)) || !this.touchStarted) {\r\n            return;\r\n        }\r\n        let p = new Laya.Vector2(event.stageX, event.stageY);\r\n        let dis = Utility.calcDistance(this.startPos, p);\r\n        if (dis >= 10 && this.lineArrVec2.length < GameLogic.WEAPON_LENGTH_MAX) {\r\n            this.lineArr.push(p.x);\r\n            this.lineArr.push(p.y);\r\n            this.lineArrVec2.push(p);\r\n            this.startPos = p;\r\n            this.drawLine();\r\n        }\r\n    }\r\n    touchEnd(event) {\r\n        if (!this.touchStarted) {\r\n            return;\r\n        }\r\n        this.touchStarted = false;\r\n        this.drawSp.graphics.clear();\r\n        if (this.lineArrVec2.length < GameLogic.WEAPON_LENGTH_MIN) {\r\n            WxApi.OpenAlert('武器太短啦，请重画！');\r\n            return;\r\n        }\r\n        GameLogic.Share.createLine3D(this.lineArrVec2);\r\n    }\r\n    touchOut(event) {\r\n        if (!this.touchStarted) {\r\n            return;\r\n        }\r\n        this.touchStarted = false;\r\n        this.drawSp.graphics.clear();\r\n        if (this.lineArrVec2.length < GameLogic.WEAPON_LENGTH_MIN) {\r\n            WxApi.OpenAlert('武器太短啦，请重画！');\r\n            return;\r\n        }\r\n        GameLogic.Share.createLine3D(this.lineArrVec2);\r\n    }\r\n    drawLine() {\r\n        this.drawSp.graphics.clear();\r\n        this.drawSp.graphics.drawLines(0, 0, this.lineArr, \"#000000\", 8);\r\n    }\r\n    safeArea(pos) {\r\n        let x1 = this.touchPanel.x - this.touchPanel.width / 2;\r\n        let x2 = this.touchPanel.x + this.touchPanel.width / 2;\r\n        let y1 = this.touchPanel.y - this.touchPanel.height / 2;\r\n        let y2 = this.touchPanel.y + this.touchPanel.height / 2;\r\n        if (pos.x < x1 || pos.x > x2 || pos.y < y1 || pos.y > y2) {\r\n            return false;\r\n        }\r\n        else {\r\n            return true;\r\n        }\r\n    }\r\n    upgradeBtnCB() {\r\n        if (this.upgradeNode.visible) {\r\n            return;\r\n        }\r\n        else {\r\n            WxApi.aldEvent('首页升级按钮：点击');\r\n            this.upgradeNode.visible = true;\r\n            Utility.tMove2D(this.moveNode, -606, this.moveNode.y, 200, () => {\r\n                this.closeUpgradePlane.off(Laya.Event.CLICK, this, this.closeUpgradeNode);\r\n                this.closeUpgradePlane.on(Laya.Event.CLICK, this, this.closeUpgradeNode);\r\n            });\r\n        }\r\n    }\r\n    closeUpgradeNode() {\r\n        this.closeUpgradePlane.off(Laya.Event.CLICK, this, this.closeUpgradeNode);\r\n        Utility.tMove2D(this.moveNode, 0, this.moveNode.y, 200, () => {\r\n            this.upgradeNode.visible = false;\r\n        });\r\n    }\r\n    skinBtnCB() {\r\n        console.log('点击皮肤按钮');\r\n        WxApi.aldEvent('皮肤界面：点击');\r\n        Laya.Scene.open('MyScenes/SkinUI.scene', false, () => { });\r\n    }\r\n    upgradePlayerCountCB() {\r\n        console.log('点击升级人数');\r\n        if (PlayerDataMgr.getPlayerCountLv() >= 5) {\r\n            return;\r\n        }\r\n        if (PlayerDataMgr.getPlayerData().coin < PlayerDataMgr.getUpgradePlayerCountLvCost()) {\r\n            WxApi.OpenAlert('金币不足！');\r\n            return;\r\n        }\r\n        WxApi.aldEvent('升级界面：人数');\r\n        PlayerDataMgr.changeCoin(-PlayerDataMgr.getUpgradePlayerCountLvCost());\r\n        PlayerDataMgr.upgradePlayerCountLv();\r\n        this.updatePlayerItem();\r\n        GameLogic.Share.upgradePlayerCount();\r\n        GameTopNode.Share.initData();\r\n    }\r\n    upgradePlayerAtkCB() {\r\n        console.log('点击升级攻击力');\r\n        if (PlayerDataMgr.getPlayerPowerLv() >= 35) {\r\n            return;\r\n        }\r\n        if (PlayerDataMgr.getPlayerData().coin < PlayerDataMgr.getUpgradePlayerPowerLvCost()) {\r\n            WxApi.OpenAlert('金币不足！');\r\n            return;\r\n        }\r\n        WxApi.aldEvent('升级界面：攻击力');\r\n        PlayerDataMgr.changeCoin(-PlayerDataMgr.getUpgradePlayerPowerLvCost());\r\n        PlayerDataMgr.upgradePlayerPowerLv();\r\n        this.updatePlayerItem();\r\n        GameTopNode.Share.initData();\r\n    }\r\n    upgradeOfflineCB() {\r\n        console.log('点击升级离线收益');\r\n        if (PlayerDataMgr.getPlayerOfflineLv() >= 56) {\r\n            return;\r\n        }\r\n        if (PlayerDataMgr.getPlayerData().coin < PlayerDataMgr.getUpgradeOfflineLvCost()) {\r\n            WxApi.OpenAlert('金币不足！');\r\n            return;\r\n        }\r\n        WxApi.aldEvent('升级界面：离线收益');\r\n        PlayerDataMgr.changeCoin(-PlayerDataMgr.getUpgradeOfflineLvCost());\r\n        PlayerDataMgr.upgradePlayerOfflineLv();\r\n        this.updatePlayerItem();\r\n        GameTopNode.Share.initData();\r\n    }\r\n    visibleOverNode(visible) {\r\n        if (visible)\r\n            WxApi.aldEvent('复活战士按钮弹出展示');\r\n        this.touchPanel.visible = !visible;\r\n        this.overNode.visible = visible;\r\n        this.upgradeBtn.visible = !visible;\r\n        this.skinBtn.visible = !visible;\r\n    }\r\n    reviveBtnCB() {\r\n        this.visibleOverNode(false);\r\n        GameLogic.Share.revivePlayer();\r\n    }\r\n    startCB() {\r\n        this.visibleOverNode(false);\r\n        GameLogic.Share.goAhead();\r\n    }\r\n    visibleBottomUI(visible) {\r\n        this.touchPanel.visible = visible;\r\n        this.upgradeBtn.visible = visible;\r\n        this.skinBtn.visible = visible;\r\n    }\r\n    visibleGameOverNode(visible) {\r\n        if (visible && !this.gameOverNode.visible) {\r\n            JJMgr.instance.closeScene(SceneDir.SCENE_DRAWUI);\r\n            AdMgr.instance.showBanner();\r\n            JJMgr.instance.openScene(SceneDir.SCENE_FINISHGAMEUI, false, { posY: 600, fixY: true });\r\n        }\r\n        else if (!visible) {\r\n            AdMgr.instance.hideBanner();\r\n            JJMgr.instance.closeScene(SceneDir.SCENE_FINISHGAMEUI);\r\n        }\r\n        this.gameOverNode.visible = visible;\r\n    }\r\n    helpBtnCB() {\r\n        WxApi.aldEvent('请求帮助：点击');\r\n        let cb = () => {\r\n            WxApi.aldEvent('请求帮助：成功');\r\n            this.visibleGameOverNode(false);\r\n            GameLogic.Share.isHelpStart = true;\r\n            GameLogic.Share.tempPlayerCount = 1;\r\n            GameLogic.Share.restartGame();\r\n        };\r\n        AdMgr.instance.showVideo(cb);\r\n    }\r\n    giveUpBtnCB() {\r\n        JJMgr.instance.openScene(SceneDir.SCENE_FULLGAMEUI, false, {\r\n            grade: PlayerDataMgr.getPlayerData().grade,\r\n            continueCallbackFun: () => {\r\n                WxApi.aldEvent('第' + PlayerDataMgr.getPlayerData().grade + '关：失败');\r\n                GameLogic.Share.isHelpStart = false;\r\n                GameLogic.Share.gradeIndex = 0;\r\n                PlayerDataMgr.getPlayerData().gradeIndex = 0;\r\n                PlayerDataMgr.setPlayerData();\r\n                this.visibleGameOverNode(false);\r\n                GameLogic.Share.restartGame();\r\n            }\r\n        });\r\n    }\r\n    createHpBar(node) {\r\n        let bar = PrefabManager.instance().getItem(PrefabItem.HpBar);\r\n        this.playerHp.addChild(bar);\r\n        let crl = bar.addComponent(FixPlayerHpBar);\r\n        crl.initData(node);\r\n    }\r\n    createSmile(node) {\r\n        let smlie = PrefabManager.instance().getItem(PrefabItem.Smile);\r\n        this.addChild(smlie);\r\n        let crl = smlie.getComponent(FixAiTips);\r\n        crl.initData(node);\r\n    }\r\n    createCry(node) {\r\n        let cry = PrefabManager.instance().getItem(PrefabItem.Cry);\r\n        this.addChild(cry);\r\n        let crl = cry.getComponent(FixAiTips);\r\n        crl.initData(node);\r\n    }\r\n    getPowerBtnCB() {\r\n        WxApi.aldEvent('获得体力：点击');\r\n        let cb = () => {\r\n            WxApi.aldEvent('获得体力：成功');\r\n            PlayerDataMgr.getPlayerData().power += 5;\r\n            PlayerDataMgr.setPlayerData();\r\n        };\r\n        AdMgr.instance.showVideo(cb);\r\n    }\r\n    checkIsNoPower() {\r\n        if (PlayerDataMgr.getPlayerData().gradeIndex == 0 && !GameLogic.Share.gameStarted && !GameLogic.Share.isHelpStart) {\r\n            let p = PlayerDataMgr.getPlayerData().power;\r\n            this.touchPanel.visible = p > 0;\r\n            this.touchNode.visible = p > 0;\r\n            this.noPowerNode.visible = p <= 0;\r\n        }\r\n    }\r\n    createCoinBoom(node) {\r\n        let op = new Laya.Vector4(0, 0, 0);\r\n        let hPos = node.transform.position.clone();\r\n        hPos.y += 1.75;\r\n        GameLogic.Share._camera.viewport.project(hPos, GameLogic.Share._camera.projectionViewMatrix, op);\r\n        let pos = new Laya.Vector2(op.x / Laya.stage.clientScaleX, op.y / Laya.stage.clientScaleY);\r\n        let desPos = new Laya.Vector2(75, 100);\r\n        Utility.coinCollectAnim(pos, desPos, this);\r\n        GameTopNode.Share.initData();\r\n    }\r\n    moreGameBtnCB() {\r\n        GameLogic.Share.pauseGame = true;\r\n        JJMgr.instance.closeScene(SceneDir.SCENE_DRAWUI);\r\n        JJMgr.instance.openScene(SceneDir.SCENE_RECOMMENDUI, false, {\r\n            closeCallbackFun: () => {\r\n                GameLogic.Share.pauseGame = false;\r\n                JJMgr.instance.openScene(SceneDir.SCENE_DRAWUI, false, { autoTime: 1500 });\r\n            }\r\n        });\r\n    }\r\n    drawGameBtnCB() {\r\n        if (GameLogic.Share.gameStarted)\r\n            JJMgr.instance.openScene(SceneDir.SCENE_DRAWUI, false, { autoTime: 1500 });\r\n        else\r\n            JJMgr.instance.openScene(SceneDir.SCENE_DRAWUI);\r\n    }\r\n}\r\n",
  "references": [
    "E:/LayaProjects/DrawWeapon/src/Mod/Utility.ts",
    "E:/LayaProjects/DrawWeapon/src/Crl/GameLogic.ts",
    "E:/LayaProjects/DrawWeapon/src/Libs/PlayerDataMgr.ts",
    "E:/LayaProjects/DrawWeapon/src/Libs/WxApi.ts",
    "E:/LayaProjects/DrawWeapon/src/View/GameTopNode.ts",
    "E:/LayaProjects/DrawWeapon/src/Libs/PrefabManager.ts",
    "E:/LayaProjects/DrawWeapon/src/Crl/FixPlayerHpBar.ts",
    "E:/LayaProjects/DrawWeapon/src/Crl/FixAiTips.ts",
    "E:/LayaProjects/DrawWeapon/src/Mod/SoundMgr.ts",
    "E:/LayaProjects/DrawWeapon/src/Mod/ShareMgr.ts",
    "E:/LayaProjects/DrawWeapon/src/JJExport/Common/JJMgr.ts",
    "E:/LayaProjects/DrawWeapon/src/Mod/AdMgr.ts"
  ]
}
