{
  "code": "import Utility from \"../Mod/Utility\";\r\nimport GameLogic from \"./GameLogic\";\r\nexport default class Player extends Laya.Script {\r\n    constructor() {\r\n        super();\r\n        this.myOwner = null;\r\n        this._ani = null;\r\n        this.weaponNode = null;\r\n        this.enemyNode = null;\r\n        this.isPlayer = true;\r\n        this.isHited = false;\r\n        this.walkSpeed = 0.01;\r\n        this.myId = 0;\r\n        this.haveWeapon = false;\r\n        this.aniSpeed = 1;\r\n        this.hp = 3;\r\n        this.isDied = false;\r\n        this.fightStarted = false;\r\n    }\r\n    onAwake() {\r\n        this.myOwner = this.owner;\r\n        this._ani = this.owner.getComponent(Laya.Animator);\r\n        this.playIdle();\r\n        this.weaponNode = Utility.findNodeByName(this.myOwner, 'Dummy001');\r\n        GameLogic.Share.gradeIndex = GameLogic.Share.gradeIndex;\r\n    }\r\n    initData(id, isPlayer) {\r\n        this.myId = id;\r\n        this.isPlayer = isPlayer;\r\n    }\r\n    playIdle() {\r\n        this._ani.speed = 1;\r\n        this._ani.crossFade(\"idle\", 0.05);\r\n    }\r\n    playWalk() {\r\n        this._ani.speed = 1;\r\n        this._ani.crossFade(\"walk\", 0.05);\r\n    }\r\n    playDied() {\r\n        this._ani.speed = 1;\r\n        this._ani.crossFade(\"die\", 0.05);\r\n    }\r\n    addWeapon(weapon) {\r\n        this.weaponNode.addChild(weapon);\r\n        weapon.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n        this.haveWeapon = true;\r\n    }\r\n    removeWeapon() {\r\n        this.weaponNode.destroyChildren();\r\n    }\r\n    goToFight(enemyNode) {\r\n        this.fightStarted = true;\r\n        this.enemyNode = enemyNode;\r\n        this.playWalk();\r\n    }\r\n    onUpdate() {\r\n        if (this.enemyNode && this.enemyNode.numChildren > 0 && !this.isHited && !this.isDied && this.fightStarted) {\r\n            let myPos = this.myOwner.transform.position.clone();\r\n            let disMin = 99999;\r\n            let closeNode = null;\r\n            for (let i = 0; i < this.enemyNode.numChildren; i++) {\r\n                let eNode = this.enemyNode.getChildAt(i);\r\n                let dis = Laya.Vector3.distance(myPos, eNode.transform.position.clone());\r\n                if (dis < disMin) {\r\n                    disMin = dis;\r\n                    closeNode = eNode;\r\n                }\r\n            }\r\n            this.myOwner.transform.lookAt(closeNode.transform.position, new Laya.Vector3(0, 1, 0));\r\n            this.myOwner.transform.rotate(new Laya.Vector3(0, 180, 0), true, false);\r\n            let dir = Utility.getDirectionAToB(this.myOwner, closeNode);\r\n            dir = new Laya.Vector3(dir.x * this.walkSpeed, dir.y * this.walkSpeed, dir.z * this.walkSpeed);\r\n            let desPos = new Laya.Vector3(0, 0, 0);\r\n            Laya.Vector3.add(myPos, dir, desPos);\r\n            this.myOwner.transform.position = desPos;\r\n        }\r\n    }\r\n    onLateUpdate() {\r\n        if (this.weaponNode && this.enemyNode && this.enemyNode.numChildren > 0 && !this.isHited && !this.isDied && this.fightStarted) {\r\n            this.checkIsHitEnemy();\r\n        }\r\n    }\r\n    checkIsHitEnemy() {\r\n        let lineNode = this.weaponNode.getChildAt(0);\r\n        if (!lineNode || lineNode == null || lineNode == undefined || this.isDied) {\r\n            return;\r\n        }\r\n        for (let i = 0; i < lineNode.numChildren; i++) {\r\n            let w = lineNode.getChildAt(i);\r\n            let wPos = w.transform.position.clone();\r\n            wPos.y = 0;\r\n            for (let j = 0; j < this.enemyNode.numChildren; j++) {\r\n                let e = this.enemyNode.getChildAt(j);\r\n                let ePos = e.transform.position.clone();\r\n                ePos.y = 0;\r\n                let dis = Laya.Vector3.distance(wPos, ePos);\r\n                if (dis <= 0.7) {\r\n                    let pCrl = e.getComponent(Player);\r\n                    pCrl.hitBack(w);\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    hitBack(node) {\r\n        if (this.isDied || this.isHited) {\r\n            return;\r\n        }\r\n        this.hp -= 1;\r\n        if (this.hp <= 0) {\r\n            this.isDied = true;\r\n            Laya.timer.once(800, this, () => {\r\n                this.playDied();\r\n                Laya.timer.once(1000, this, () => {\r\n                    this.owner.destroy();\r\n                });\r\n            });\r\n            return;\r\n        }\r\n        this.isHited = true;\r\n        let pA = node.transform.position.clone();\r\n        let pB = this.myOwner.transform.position.clone();\r\n        let dir = new Laya.Vector3(0, 0, 0);\r\n        Laya.Vector3.subtract(pB, pA, dir);\r\n        Laya.Vector3.normalize(dir, dir);\r\n        dir = new Laya.Vector3(dir.x * 1, 0, dir.z * 1);\r\n        let myPos = this.myOwner.transform.position.clone();\r\n        Laya.Vector3.add(myPos, dir, myPos);\r\n        Utility.TmoveTo(this.myOwner, 200, myPos, () => { this.isHited = false; });\r\n    }\r\n}\r\n",
  "references": [
    "E:/LayaProjects/DrawWeapon/src/Mod/Utility.ts",
    "E:/LayaProjects/DrawWeapon/src/Crl/GameLogic.ts"
  ]
}
