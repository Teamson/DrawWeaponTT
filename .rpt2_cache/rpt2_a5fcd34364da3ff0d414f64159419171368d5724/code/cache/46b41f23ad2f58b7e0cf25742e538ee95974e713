{
  "code": "import Utility from \"../Mod/Utility\";\r\nimport GameLogic from \"./GameLogic\";\r\nimport PlayerDataMgr from \"../Libs/PlayerDataMgr\";\r\nimport Boss from \"./Boss\";\r\nimport WxApi from \"../Libs/WxApi\";\r\nimport GameUI from \"../View/GameUI\";\r\nimport SoundMgr from \"../Mod/SoundMgr\";\r\nexport default class Player extends Laya.Script {\r\n    constructor() {\r\n        super();\r\n        this.myOwner = null;\r\n        this._ani = null;\r\n        this.weaponNode = null;\r\n        this.enemyNode = null;\r\n        this.embNode = null;\r\n        this.closeNode = null;\r\n        this.isPlayer = true;\r\n        this.isHited = false;\r\n        this.haveWeapon = false;\r\n        this.isDied = false;\r\n        this.fightStarted = false;\r\n        this.weaponLength = 5;\r\n        this.walkSpeed = 0.08;\r\n        this.myId = 0;\r\n        this.backDistance = 8;\r\n        this.weaponSpeed = 1;\r\n        this.hpMax = 100;\r\n        this.hp = 100;\r\n        this.atk = 20;\r\n        this.embScale = null;\r\n        this.embPos = null;\r\n        this.embRotation = null;\r\n        this.isBossState = false;\r\n    }\r\n    onAwake() {\r\n        this.myOwner = this.owner;\r\n        this._ani = this.owner.getComponent(Laya.Animator);\r\n        this.playIdle1();\r\n        this.weaponNode = Utility.findNodeByName(this.myOwner, 'Dummy_Arms');\r\n        this.embNode = Utility.findNodeByName(this.myOwner, 'Dummy_Emb');\r\n        let emb = Utility.findNodeByName(this.myOwner, 'Hero1_Emb');\r\n        this.embScale = emb.transform.localScale.clone();\r\n        this.embPos = emb.transform.localPosition.clone();\r\n        this.embRotation = emb.transform.localRotation.clone();\r\n    }\r\n    initData(id, isPlayer) {\r\n        this.myId = id;\r\n        this.isPlayer = isPlayer;\r\n        if (!this.isPlayer) {\r\n            this.playIdle2();\r\n        }\r\n        if (isPlayer) {\r\n            this.changeSkin(PlayerDataMgr.freeSkinId != -1 ? PlayerDataMgr.freeSkinId : PlayerDataMgr.getPlayerData().playerId);\r\n            this.hp = PlayerDataMgr.getPlayerPowerData().hp;\r\n            this.hpMax = this.hp;\r\n            this.atk = PlayerDataMgr.getPlayerPowerData().atk;\r\n        }\r\n    }\r\n    playIdle1() {\r\n        this._ani.speed = 1;\r\n        this._ani.crossFade(\"idle1\", 0.05);\r\n    }\r\n    playIdle2() {\r\n        this._ani.speed = 1;\r\n        this._ani.crossFade(\"idle2\", 0.05);\r\n    }\r\n    playWalk() {\r\n        this._ani.play(\"walk\", 0, 0);\r\n        this._ani.crossFade(\"hit\", 0.05, 1);\r\n        let crl = this._ani.getControllerLayer(1);\r\n        crl.getAnimatorState('hit').speed = this.getPlayerAniSpeed();\r\n    }\r\n    playDied() {\r\n        this._ani.crossFade(\"died\", 0.05);\r\n        let crl = this._ani.getControllerLayer(1);\r\n        crl.getAnimatorState('hit').speed = 0;\r\n    }\r\n    getPlayerAniSpeed() {\r\n        let wLength = this.weaponLength;\r\n        if (wLength > 50) {\r\n            return this.weaponSpeed - this.weaponSpeed * (wLength - 50) * 0.01;\r\n        }\r\n        else {\r\n            return this.weaponSpeed;\r\n        }\r\n    }\r\n    getHitbackDistance() {\r\n        let wLength = this.weaponLength;\r\n        if (wLength > 50) {\r\n            return this.backDistance - this.backDistance * (wLength - 50) * 0.01;\r\n        }\r\n        else {\r\n            return this.backDistance;\r\n        }\r\n    }\r\n    addWeapon(weapon) {\r\n        this.weaponNode.addChild(weapon);\r\n        this.weaponLength = this.weaponNode.getChildAt(0).numChildren > 100 ? 100 : this.weaponNode.getChildAt(0).numChildren;\r\n        weapon.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n        this.haveWeapon = true;\r\n        if (this.weaponNode.numChildren > 30) {\r\n            this.atk = this.atk * (1 + (this.weaponNode.numChildren - 30) * 0.005);\r\n        }\r\n        if (this.isPlayer) {\r\n            SoundMgr.instance.playSoundEffect('weaponReady.mp3');\r\n        }\r\n        this.playIdle2();\r\n    }\r\n    removeWeapon() {\r\n        this.weaponNode.destroyChildren();\r\n    }\r\n    goToFight(enemyNode) {\r\n        if (this.isPlayer) {\r\n            if (this.hp == this.hpMax) {\r\n                this.hp = PlayerDataMgr.getPlayerPowerData().hp;\r\n                this.hpMax = this.hp;\r\n            }\r\n            this.atk = PlayerDataMgr.getPlayerPowerData().atk;\r\n        }\r\n        else {\r\n            if (this.hp == this.hpMax) {\r\n                this.hp = PlayerDataMgr.getNpcData().hp;\r\n                this.hpMax = this.hp;\r\n            }\r\n            this.atk = PlayerDataMgr.getNpcData().atk;\r\n        }\r\n        this.fightStarted = true;\r\n        this.enemyNode = enemyNode;\r\n        this.isBossState = PlayerDataMgr.getPlayerData().gradeIndex >= 3;\r\n        this.playWalk();\r\n    }\r\n    onUpdate() {\r\n        if (this.enemyNode && this.enemyNode.numChildren > 0 && !this.isHited && !this.isDied && this.fightStarted && !GameLogic.Share.pauseGame) {\r\n            let myPos = this.myOwner.transform.position.clone();\r\n            let disMin = 99999;\r\n            let closeNode = null;\r\n            for (let i = 0; i < this.enemyNode.numChildren; i++) {\r\n                let eNode = this.enemyNode.getChildAt(i);\r\n                if (!eNode || !eNode.transform)\r\n                    continue;\r\n                let crl = eNode.getComponent(Player);\r\n                if (crl && crl.isDied)\r\n                    continue;\r\n                let dis = Laya.Vector3.distance(myPos, eNode.transform.position.clone());\r\n                if (dis < disMin) {\r\n                    disMin = dis;\r\n                    closeNode = eNode;\r\n                }\r\n            }\r\n            if (this.closeNode && this.closeNode.transform && this.closeNode.getComponent(Player) && !(this.closeNode.getComponent(Player).isDied)) {\r\n                closeNode = this.closeNode;\r\n            }\r\n            else {\r\n                this.closeNode = null;\r\n                this.closeNode = closeNode;\r\n            }\r\n            if (!closeNode)\r\n                return;\r\n            this.myOwner.transform.lookAt(closeNode.transform.position, new Laya.Vector3(0, 1, 0));\r\n            this.myOwner.transform.rotate(new Laya.Vector3(0, 180, 0), true, false);\r\n            let dir = Utility.getDirectionAToB(this.myOwner, closeNode);\r\n            dir = new Laya.Vector3(dir.x * this.walkSpeed, dir.y * this.walkSpeed, dir.z * this.walkSpeed);\r\n            let desPos = new Laya.Vector3(0, 0, 0);\r\n            Laya.Vector3.add(myPos, dir, desPos);\r\n            if (this.isBossState && disMin < 6) {\r\n                return;\r\n            }\r\n            else if (!this.isBossState && disMin < 0.5) {\r\n                return;\r\n            }\r\n            this.myOwner.transform.position = desPos;\r\n        }\r\n    }\r\n    onLateUpdate() {\r\n        if (this.weaponNode && this.enemyNode && this.enemyNode.numChildren > 0 && !this.isHited && !this.isDied && this.fightStarted && !GameLogic.Share.pauseGame) {\r\n            this.checkIsHitEnemy();\r\n        }\r\n    }\r\n    checkIsHitEnemy() {\r\n        let lineNode = this.weaponNode.getChildAt(0);\r\n        if (!lineNode || lineNode == null || lineNode == undefined || this.isDied) {\r\n            return;\r\n        }\r\n        for (let i = 0; i < lineNode.numChildren; i++) {\r\n            let w = lineNode.getChildAt(i);\r\n            let wPos = w.transform.position.clone();\r\n            wPos.y = 0;\r\n            for (let j = 0; j < this.enemyNode.numChildren; j++) {\r\n                let e = this.enemyNode.getChildAt(j);\r\n                let ePos = e.transform.position.clone();\r\n                ePos.y = 0;\r\n                let dis = Laya.Vector3.distance(wPos, ePos);\r\n                if (!this.isBossState && dis <= 1) {\r\n                    let pCrl = e.getComponent(Player);\r\n                    pCrl.hitBack(w, this.atk, this.myOwner);\r\n                    return;\r\n                }\r\n                else if (this.isBossState && dis <= 5) {\r\n                    let pCrl = e.getComponent(Boss);\r\n                    pCrl.hitBack(this.atk);\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    hitBack(node, atk, from) {\r\n        if (this.isDied || this.isHited) {\r\n            return;\r\n        }\r\n        if (!this.isPlayer) {\r\n            WxApi.DoVibrate();\r\n        }\r\n        let id = Utility.GetRandom(1, 4);\r\n        SoundMgr.instance.playSoundEffect('weaponHit' + id + '.mp3');\r\n        this.createHitFX();\r\n        this.hp -= atk;\r\n        if (this.hp <= 0) {\r\n            if (!this.isPlayer) {\r\n                GameUI.Share.createCry(this.myOwner);\r\n                GameUI.Share.createCoinBoom(this.myOwner);\r\n                PlayerDataMgr.changeCoin(10);\r\n                SoundMgr.instance.playSoundEffect('getCoin.mp3');\r\n            }\r\n            else {\r\n                GameUI.Share.createSmile(from);\r\n            }\r\n            let id = Utility.GetRandom(1, 2);\r\n            SoundMgr.instance.playSoundEffect('die' + id + '.mp3');\r\n            this.isDied = true;\r\n            this.playDied();\r\n            Laya.timer.once(1000, this, () => {\r\n                this.owner.destroy();\r\n            });\r\n            return;\r\n        }\r\n        this.isHited = true;\r\n        let pA = node.transform.position.clone();\r\n        let pB = this.myOwner.transform.position.clone();\r\n        let dir = new Laya.Vector3(0, 0, 0);\r\n        Laya.Vector3.subtract(pB, pA, dir);\r\n        Laya.Vector3.normalize(dir, dir);\r\n        dir = new Laya.Vector3(dir.x * this.getHitbackDistance(), 0, dir.z * this.getHitbackDistance());\r\n        let myPos = this.myOwner.transform.position.clone();\r\n        Laya.Vector3.add(myPos, dir, myPos);\r\n        Utility.TmoveTo(this.myOwner, 200, myPos, () => { this.isHited = false; });\r\n    }\r\n    createHitFX() {\r\n        let hit = Laya.loader.getRes(WxApi.UnityPath + 'hitFX.lh');\r\n        let fx = Laya.Sprite3D.instantiate(hit, this.myOwner, true, new Laya.Vector3(0, 2, 0));\r\n        fx.transform.localPosition = new Laya.Vector3(0, 1.5, 0);\r\n        Laya.timer.once(1000, GameLogic.Share, () => {\r\n            fx.destroy();\r\n        });\r\n    }\r\n    changeSkin(id) {\r\n        let mats = new Laya.UnlitMaterial();\r\n        Laya.Texture2D.load('res/skinHero/HeroD_' + (id + 1) + '.png', Laya.Handler.create(this, function (tex) {\r\n            mats.albedoTexture = tex;\r\n        }));\r\n        for (let i = 1; i <= 4; i++) {\r\n            let mesh3d = this.owner.getChildAt(i);\r\n            mesh3d.skinnedMeshRenderer.material = mats;\r\n        }\r\n        this.embNode.destroyChildren();\r\n        let embRes = Laya.loader.getRes(WxApi.UnityPath + 'Hero' + (id + 1) + '_Emb.lh');\r\n        let emb = Laya.Sprite3D.instantiate(embRes, this.embNode, false, new Laya.Vector3(0, 0, 0));\r\n        emb.transform.localScale = this.embScale;\r\n        emb.transform.localPosition = this.embPos;\r\n        emb.transform.localRotation = this.embRotation;\r\n    }\r\n}\r\n",
  "references": [
    "E:/LayaProjects/DrawWeapon/src/Mod/Utility.ts",
    "E:/LayaProjects/DrawWeapon/src/Crl/GameLogic.ts",
    "E:/LayaProjects/DrawWeapon/src/Libs/PlayerDataMgr.ts",
    "E:/LayaProjects/DrawWeapon/src/Crl/Boss.ts",
    "E:/LayaProjects/DrawWeapon/src/Libs/WxApi.ts",
    "E:/LayaProjects/DrawWeapon/src/View/GameUI.ts",
    "E:/LayaProjects/DrawWeapon/src/Mod/SoundMgr.ts"
  ]
}
